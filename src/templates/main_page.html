<!DOCTYPE html>
<html>
	<head>
		<title>Lukuvinkit - Etusivu</title>
	</head>
	<body>
		<header>
			<h1>Lukuvinkit <span style="color:#a8a7aa">v0.02 :)</span></h1>
		</header>
		{% if username == None %}
		<div style="margin-bottom: 20px">
			<a href="/signup" id="signup">Luo käyttäjä</a>
			<a href="/login" id="login">Kirjaudu sisään</a>
			<a href = "/search" id="searchpage">Haku</a>
		</div>
		{% else %}
		<div>
			<p>
				{{ username }} kirjautuneena
			</p>
			<p>
				<a href="/logout" id="logout">Kirjaudu ulos</a>
				<label for="ownTips">
					<input type="checkbox" id="ownTips"> Omat vinkit
				</label>
				<a href = "/search" id="searchpage">Haku</a>
			</p>
		</div>
		{% endif %}
		<div id="tipsWrapper">
		</div>
		<div>
			<h2>Lisää vinkki</h2>
			<form action="/add" method="POST">
				title <input type = "text" name = "title" id = "title"><br>
				url <input type = "text" name = "url" id = "url"><br>
				<input type="submit" value="Lisää" />
			</form>
		</div>
		
		<script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

		<script type = "text/javascript">
			const urlField = document.getElementById('url')

			urlField.addEventListener('focusout', (e) => {
				givenUrl = urlField.value
					//ajax tekee asynkronisen post-pyynnön urliin '/check', joka kutsuu
					//kerrosten kautta loppupeleissä funktiota joka tekee pyynnön
					//pyydettyyn urliin ja kattoo mitä palauttaa.
					//tällä hetkellä tulos palautetaan titlen input-kenttään
					$.ajax({
					type: "POST",
					url: "/check",
					data: givenUrl,
					success: function(response) {
						document.getElementById('title').value = response
						console.log(response)
					}
				})
			})
		</script>
		
		

		<script type="text/javascript">
			{% if username != None %}
			let ownTipsCheckbox = document.getElementById('ownTips');
			{% endif %}
			let tipsWrapper = document.getElementById('tipsWrapper');

			let tips = [{% for t in tips[1:] %}{
				"id": "{{ t[0] }}",
				"title": "{{ t[1] }}",
				"url": "{{ t[2] }}",
				"own": {{ 1 if t[3] == user_id else 0}},
				"is_read": {{ 1 if t[4] == '1' else 0 }},
				"updated": "{{ t[5] }}"
			},{% endfor %}];

			let ownTips = tips.filter(t => t['own'] == 1);

			const refreshTips = () => {
				tipsWrapper.innerHTML = '';
				{% if username != None %}
				let tipsToShow = ownTipsCheckbox.checked ? ownTips : tips;
				{% else %}
				let tipsToShow = tips;
				{% endif %}

				let ul = document.createElement('ul');
				ul.setAttribute('id', 'tipsList');
				for (let i = 0; i < tipsToShow.length; i++) {
					let li = document.createElement('li');
					let a = document.createElement('a'); 
					let linkText = document.createTextNode(tipsToShow[i].url);
					a.appendChild(linkText); 
					a.title = tipsToShow[i].title;
					let prefix = '';
					if (tipsToShow[i].url.substring(0,4) != 'http') {
						prefix += 'https://';
					}
					a.href = prefix + tipsToShow[i].url;
					a.target = '_blank';
					li.innerHTML = tipsToShow[i].title + ' - ';
					li.append(a);

					{% if username != None %}
					let aMarkAsRead = document.createElement('a'); 
					let linkTextMarkAsRead = document.createTextNode(
						( tips[i].is_read == '1') ? 'Merkitse lukemattomaksi' : 'Merkitse luetuksi'
					);
					aMarkAsRead.appendChild(linkTextMarkAsRead); 
					aMarkAsRead.href = '/toggle/' + tips[i].id;
					li.append(' - ');
					li.append(aMarkAsRead);

					if ( tips[i].is_read == '1' ){
						let markedAsRead = document.createTextNode(' (' + tips[i].updated + ')');
						li.append(markedAsRead);
					}
					{% endif %}
					
					ul.append(li);
				}
				tipsWrapper.append(ul);
			};

			{% if username != None %}
			ownTipsCheckbox.addEventListener('click', refreshTips);
			{% endif %}
			refreshTips();
		</script>
		
	</body>
</html>