<!DOCTYPE html>
<html>
	<head>
		<title>Lukuvinkit - Etusivu</title>
	</head>
	<body>
		<header>
			<h1>Lukuvinkit <span style="color:#a8a7aa">v0.02 :)</span></h1>
		</header>
		{% if username == None %}
		<div style="margin-bottom: 20px">
			<a href="/signup" id="signup">Luo käyttäjä</a>
			<a href="/login" id="login">Kirjaudu sisään</a>
			<a href = "/search" id="searchpage">Haku</a>
		</div>
		{% else %}
		<div>
			<p>
			{{ username }} kirjautuneena
			<a href="/logout" id="logout">Kirjaudu ulos</a>
			<label for="own-tips">
				<input type="checkbox" id="ownTips"> Omat vinkit
			</label>
			<a href = "/search" id="searchpage">Haku</a>
		</p>
		</div>
		{% endif %}
		<div id="tipsWrapper">
			<ul id="tipsList">
			</ul>
		</div>
		<div>
			<h2>Lisää vinkki</h2>
			<form action="/add" method="POST">
				{% for i in range((tips[0]|length)) %}
					{% if tips[0][i] != 'user_id' and tips[0][i] != 'id' %}
					<label for = {{ tips[0][i] }}>
						{{ tips[0][i] }}
					</label>
					<input type="text" name={{ tips[0][i] }} />
					<br />
					{% endif %}
				{% endfor %}
				<input type="submit" value="Lisää" />
			</form>
		</div>

		<script type="text/javascript">
			{% if username != None %}
			let ownTipsCheckbox = document.getElementById('ownTips');
			{% endif %}
			let tipsListDiv = document.getElementById('tipsList');

			let tips = [{% for t in tips[1:] %}{
				"title": "{{ t[0] }}",
				"url": "{{ t[1] }}",
				"own": {{ 1 if t[2] == user_id else 0}}
			},{% endfor %}];

			let ownTips = tips.filter(t => t['own'] == 1);

			const refreshTips = () => {
				tipsListDiv.innerHTML = '';
				{% if username != None %}
				let tipsToShow = ownTipsCheckbox.checked ? ownTips : tips;
				{% else %}
				let tipsToShow = tips;
				{% endif %}

				for (let i = 0; i < tipsToShow.length; i++) {
					let li = document.createElement('li');
					let a = document.createElement('a'); 
					let linkText = document.createTextNode(tipsToShow[i].url);
					a.appendChild(linkText); 
					a.title = tipsToShow[i].title;
					let prefix = '';
					if (tipsToShow[i].url.substring(0,4) != 'http') {
						prefix += 'https://';
					}
					a.href = prefix + tipsToShow[i].url;
					a.target = '_blank';
					li.innerHTML = tipsToShow[i].title + ' - ';
					li.append(a);
					tipsListDiv.append(li);
				}
			};

			{% if username != None %}
			ownTipsCheckbox.addEventListener('click', refreshTips);
			{% endif %}
			refreshTips();
		</script>
	</body>
</html>